# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none
pr: none

schedules:
- cron: "0 */2 * * *"
  displayName: Hourly build
  branches:
    include:
    - main
  always: true

name: $(TeamProject)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

variables:
  - name: PUBLISH_URL_PREFIX
    value: 'https://sonicazurepipelines.blob.core.windows.net/build'
  - group: sonicbld

stages:
- stage: Build
  pool: sonicso1ES-amd64
  jobs:
  - job: Build
    timeoutInMinutes: 120
    steps:
    - script: |
        set -ex
        # Install azcopy
        curl -sL https://aka.ms/downloadazcopy-v10-linux | tar -xz
        sudo mv azcopy_linux_amd64_*/azcopy /usr/local/bin/
        # Install Azure cli
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az version
      displayName: Install Azure CLI
    - task: AzureCLI@2
      displayName: Install build tools
      inputs:
        azureSubscription: 'WIF-soniccr1'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -ex
          az account show
          sudo apt-get update
          sudo apt-get install -y python3-pip jq
          sudo pip3 install --break-system-package azure-storage-queue azure-storage-blob pytz python-dateutil azure.core azure.kusto.data azure.kusto.ingest
    - task: AzureCLI@2
      displayName: Upload RP into kusto
      inputs:
        azureSubscription: 'WIF-soniccr1'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -ex
          export AZCOPY_AUTO_LOGIN_TYPE=AZCLI
          azcopy cp "$(PUBLISH_URL_PREFIX)/info/pullrequests.json" ./pullrequests.json --overwrite=true
          timestamp=$(jq -r '.timestamp' pullrequests.json)
          echo "Get timestamp: $timestamp"
          timestamp='2024-11-19T02:04:27.958534+00:00'
          
          new_timestamp=$(python3 azure-pipelines/scripts/publish-github-prs.py $GITHUB_TOKEN $timestamp | tail -n 1) 
          # update blob timestamp if new_timestamp is not empty
          if [ -n "$new_timestamp" ]; then
            echo "Update timestamp to: $new_timestamp"
            echo -n "{\"timestamp\": \"$new_timestamp\"}" > ./temp.json
            mv temp.json pullrequests.json
            azcopy cp ./pullrequests.json "$(PUBLISH_URL_PREFIX)/info/pullrequests.json"
          else
            echo "No update to timestamp."
          fi
      env:
        GITHUB_TOKEN: $(GITHUB-TOKEN)