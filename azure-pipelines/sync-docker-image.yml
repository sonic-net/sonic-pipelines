trigger: none
pr: none
schedules:
- cron: "0 0 * * *"
  branches:
    include:
    - main
  always: true
parameters:
  - name: platforms
    type: object
    default:
      - vs
      - marvell-prestera-armhf
      - marvell-prestera-arm64

jobs:
  - job: Build
    pool: sonic-ubuntu-1c
    timeoutInMinutes: 20
    steps:
      - checkout: self
        clean: true
      - script: |
          set -ex
          # Wait for apt lock to be released (timeout after 10 minutes)
          timeout=600
          elapsed=0
          while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || sudo fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
            if [ $elapsed -ge $timeout ]; then
              echo "Timeout waiting for apt lock after 10 minutes"
              exit 1
            fi
            echo "Waiting for apt lock to be released..."
            sleep 5
            elapsed=$((elapsed + 5))
          done

          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        retryCountOnTaskFailure: 5
        displayName: install dependencies
      - ${{ each platform in parameters.platforms }}:
        - task: DownloadPipelineArtifact@2
          displayName: Download ${{ platform }} versions-docker file
          inputs:
            source: specific
            project: build
            pipeline: Azure.sonic-buildimage.official.${{ platform }}
            runVersion: 'latestFromBranch'
            runBranch: 'refs/heads/master'
            path: download
            patterns: |
              **/target/versions/default/versions-docker
      - script: |
          set -ex

          az login --identity
          az account set --subscription 90318812-d77d-426d-90a3-44997faf17f4
          images=$(find download -name versions-docker | xargs -i grep -v "==$" {} | awk -F== '{print$1}' | sed -e "s/amd64://" -e "s/arm64://" -e "s/armhf://" | sort -u )
          for i in $images $SYNC_DOCKER_IMAGE_EXTRA
          do
            source=$i
            if [[ "$i" == debian* ]] || [[ "$i" == ubuntu* ]]; then
              source=library/$i
            fi
            # az acr import -n PublicMirror --source docker.io/$source --image $i --force -u $user -p $pass
          done
        displayName: push image to PublicMirror
        env:
          user: $(user1)
          pass: $(pass1)
      - script: |
          set -ex

          K8s_GCR_IO_PAUSE_VERSION=3.5
          MASTER_PAUSE_VERSION=3.5
          MASTER_KUBERNETES_CONTAINER_IMAGE_VERSION=v1.22.2
          MASTER_COREDNS_VERSION=v1.8.4
          MASTER_ETCD_VERSION=3.5.0-0
          k8s_images=(
            pause:${K8s_GCR_IO_PAUSE_VERSION} \
            pause:${MASTER_PAUSE_VERSION} \
            kube-apiserver:${MASTER_KUBERNETES_CONTAINER_IMAGE_VERSION} \
            kube-controller-manager:${MASTER_KUBERNETES_CONTAINER_IMAGE_VERSION} \
            kube-scheduler:${MASTER_KUBERNETES_CONTAINER_IMAGE_VERSION} \
            kube-proxy:${MASTER_KUBERNETES_CONTAINER_IMAGE_VERSION} \
            coredns/coredns:${MASTER_COREDNS_VERSION} \
            etcd:${MASTER_ETCD_VERSION}
          )
          # for i in "${k8s_images[@]}"
          # do
          #   # az acr import -n PublicMirror --source k8s.gcr.io/$i --image $i --force -u $user -p $pass
          # done
        displayName: push k8s image to PublicMirror
        env:
          user: $(user1)
          pass: $(pass1)
      - script: |
          set -ex

          MASTER_UI_DASH_VERSION=v2.7.0
          MASTER_UI_METRIC_VERSION=v1.0.8
          kubernetesui_images=(
            kubernetesui/metrics-scraper:${MASTER_UI_METRIC_VERSION} \
            kubernetesui/dashboard:${MASTER_UI_DASH_VERSION}
          )
          for i in "${kubernetesui_images[@]}"
          do
            az acr import -n PublicMirror --source docker.io/$i --image $i --force -u $user -p $pass
          done
        displayName: push kubernetesui image to PublicMirror
        env:
          user: $(user1)
          pass: $(pass1)
      - script: |
          set -ex

          MASTER_MDM_VERSION=2.2023.505.1124-45da18-20230505t1700
          MASTER_MDS_VERSION=mariner_20230517.1
          MASTER_FLUENTD_VERSION=mariner_20230517.1
          geneva_images=(
            distroless/genevamdm:${MASTER_MDM_VERSION} \
            distroless/genevamdsd:${MASTER_MDS_VERSION} \
            distroless/genevafluentd_td-agent:${MASTER_FLUENTD_VERSION}
          )
          for i in "${geneva_images[@]}"
          do
            az acr import -n PublicMirror --source linuxgeneva-microsoft.azurecr.io/$i --image $i --force -u $user -p $pass
          done
        displayName: push linuxgeneva image to PublicMirror
        env:
          user: $(user1)
          pass: $(pass1)